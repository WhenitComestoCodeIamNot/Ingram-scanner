import requests

from loguru import logger

from .base import POCTemplate


class CVE_2025_31700(POCTemplate):
    """Dahua Pre-Auth RCE via ONVIF Host Header Overflow

    Certain Dahua IP cameras and NVRs are vulnerable to a pre-authentication
    remote code execution via a stack-based buffer overflow in the ONVIF
    device service handler triggered by an oversized Host header.
    This POC only checks if the ONVIF endpoint is exposed without auth;
    it does NOT send any overflow payload. CVSS 8.1 High.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['dahua']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2025-31700
        """
        self.level = POCTemplate.level.high
        self.desc = """Dahua pre-auth RCE via ONVIF Host header buffer overflow.
        CVSS 8.1. This check only detects the exposed ONVIF service endpoint
        without sending destructive payloads."""

    def verify(self, ip, port=80):
        """Check if Dahua ONVIF endpoint is accessible without authentication"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Check ONVIF device_service endpoint with a normal GET request
        url = self._get_url(ip, port, '/onvif/device_service')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and ('onvif' in r.text.lower() or 'Envelope' in r.text or 'SOAP' in r.text):
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        # Also try a SOAP probe to the ONVIF endpoint
        soap_body = (
            '<?xml version="1.0" encoding="UTF-8"?>'
            '<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope"'
            ' xmlns:tds="http://www.onvif.org/ver10/device/wsdl">'
            '<s:Body><tds:GetDeviceInformation/></s:Body>'
            '</s:Envelope>'
        )
        try:
            r = requests.post(
                url,
                headers={**headers, 'Content-Type': 'application/soap+xml; charset=utf-8'},
                proxies=proxies,
                data=soap_body,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and ('Envelope' in r.text or 'onvif' in r.text.lower()):
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2025_31700)
