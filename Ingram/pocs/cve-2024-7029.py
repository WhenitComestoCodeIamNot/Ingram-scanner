import requests

from loguru import logger

from .base import POCTemplate


class CVE_2024_7029(POCTemplate):
    """AVTECH Camera Command Injection

    AVTECH IP cameras contain a command injection vulnerability in the
    brightness argument of the /cgi-bin/supervisor/Factory.cgi endpoint.
    Unauthenticated attackers can inject and execute arbitrary OS commands.
    CVSS 8.8 High.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['avtech']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2024-7029
        https://www.cisa.gov/known-exploited-vulnerabilities-catalog
        """
        self.level = POCTemplate.level.high
        self.desc = """AVTECH IP camera command injection via Factory.cgi endpoint.
        CVSS 8.8. Unauthenticated remote code execution through the brightness
        parameter. Actively exploited in the wild."""

    def verify(self, ip, port=80):
        """Check for vulnerable AVTECH endpoints without sending malicious payloads"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Check Factory.cgi endpoint (the vulnerable endpoint)
        url = self._get_url(ip, port, '/cgi-bin/supervisor/Factory.cgi?action=setup&setuppowerful=0')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and ('OK' in r.text or 'AVTECH' in r.text):
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        # Check Machine.cgi info disclosure endpoint (no auth needed)
        url = self._get_url(ip, port, '/cgi-bin/nobody/Machine.cgi?action=get_capability')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and ('Capability' in r.text or 'capability' in r.text or 'Product' in r.text):
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2024_7029)
