import requests

from loguru import logger

from .base import POCTemplate


class CVE_2023_21413(POCTemplate):
    """Axis OS Command Injection

    AXIS OS devices contain an OS command injection vulnerability in the
    ACAP application upload functionality. Authenticated attackers with
    operator or admin privileges can execute arbitrary commands. However,
    the device can also be fingerprinted via unauthenticated info disclosure
    endpoints. CVSS 9.1 Critical.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['axis']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2023-21413
        https://www.axis.com/dam/public/a1/26/43/cve-2023-21413-en-US-417789.pdf
        """
        self.level = POCTemplate.level.high
        self.desc = """Axis OS command injection via ACAP application upload endpoint.
        CVSS 9.1. Attackers can execute arbitrary OS commands on affected
        Axis network cameras and other AXIS OS devices."""

    def verify(self, ip, port=80):
        """Check for vulnerable Axis endpoints via info disclosure"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Check param.cgi info disclosure (should require auth but often doesn't)
        url = self._get_url(ip, port, '/axis-cgi/param.cgi?action=list&group=root.Properties')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and ('root.Properties' in r.text or 'Brand=AXIS' in r.text):
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        # Check systemlog.cgi without auth
        url = self._get_url(ip, port, '/axis-cgi/admin/systemlog.cgi')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and ('axis' in r.text.lower() or 'syslog' in r.text.lower()):
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2023_21413)
