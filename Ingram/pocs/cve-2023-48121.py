import requests

from loguru import logger

from .base import POCTemplate


class CVE_2023_48121(POCTemplate):
    """Ezviz Camera Authentication Bypass

    Ezviz Internet PT cameras are vulnerable to an authentication bypass
    that allows attackers to access device endpoints without proper
    encryption or credentials. Affected devices can be fingerprinted
    by checking for accessible API and web interface endpoints.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['ezviz']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2023-48121
        """
        self.level = POCTemplate.level.high
        self.desc = """Ezviz camera authentication bypass allowing unauthenticated
        access to device endpoints without proper encryption. Attackers can
        access device info and control functions."""

    def verify(self, ip, port=80):
        """Check for accessible Ezviz device endpoints"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Check main page for EZVIZ fingerprint
        url = self._get_url(ip, port, '/')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and ('EZVIZ' in r.text or 'ezviz' in r.text):
                # Device identified as EZVIZ, check API endpoint
                api_url = self._get_url(ip, port, '/api/v1/device/info')
                try:
                    r2 = requests.get(
                        api_url,
                        headers=headers,
                        proxies=proxies,
                        verify=False,
                        timeout=self.config.timeout,
                        allow_redirects=False
                    )
                    if r2.status_code == 200:
                        return ip, str(port), self.product, 'N/A', 'N/A', self.name
                except Exception as e:
                    logger.error(e)
                # Even if API check fails, the device is EZVIZ and potentially vulnerable
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        # Direct check on API endpoint
        url = self._get_url(ip, port, '/api/v1/device/info')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200:
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2023_48121)
