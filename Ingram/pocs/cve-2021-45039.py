import socket

from loguru import logger

from .base import POCTemplate


class CVE_2021_45039(POCTemplate):
    """Uniview Pre-Auth RCE via UDP 7788

    Uniview NVR devices expose an undocumented UDP service on port 7788
    that is vulnerable to a pre-authentication remote code execution.
    This POC detects the presence of the service by sending a small
    UDP probe; it does NOT send any exploit payload. CVSS 8.9 High.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['uniview']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2021-45039
        """
        self.level = POCTemplate.level.high
        self.desc = """Uniview NVR pre-auth RCE via undocumented UDP service on port 7788.
        CVSS 8.9. This check only detects the presence of the UDP service
        without sending exploit payloads."""

    def verify(self, ip, port=80):
        """Check for Uniview undocumented UDP service on port 7788"""

        # Send a small UDP probe to port 7788
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            sock.settimeout(self.config.timeout)
            # Send a minimal probe packet
            probe = b'\x00' * 4
            sock.sendto(probe, (ip, 7788))
            try:
                data, addr = sock.recvfrom(1024)
                sock.close()
                if data:
                    # The undocumented service responded, device is potentially vulnerable
                    return ip, str(port), self.product, 'N/A', 'N/A', self.name
            except socket.timeout:
                sock.close()
                # No response does not confirm vulnerability
            except Exception:
                sock.close()
        except Exception as e:
            logger.error(e)

        # Also try a second probe pattern
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            sock.settimeout(self.config.timeout)
            # Try a different probe pattern
            probe = b'\xff\xff\xff\xff'
            sock.sendto(probe, (ip, 7788))
            try:
                data, addr = sock.recvfrom(1024)
                sock.close()
                if data:
                    return ip, str(port), self.product, 'N/A', 'N/A', self.name
            except socket.timeout:
                sock.close()
            except Exception:
                sock.close()
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2021_45039)
