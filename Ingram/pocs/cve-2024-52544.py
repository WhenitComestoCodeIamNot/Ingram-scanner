import socket
import requests

from loguru import logger

from .base import POCTemplate


class CVE_2024_52544(POCTemplate):
    """Lorex Camera Stack Buffer Overflow Detection

    Lorex 2K Indoor/Outdoor Wi-Fi Security Cameras (models W461ASC and
    W462AQC) contain multiple stack-based buffer overflow vulnerabilities
    in the DP (Discovery Protocol) service on TCP port 3500. This POC
    only detects the presence of the vulnerable service; it does NOT
    send any overflow payload. CVSS Critical.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['lorex']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2024-52544
        https://www.rapid7.com/blog/post/2025/01/lorex-camera-vulnerabilities/
        """
        self.level = POCTemplate.level.high
        self.desc = """Lorex 2K camera stack buffer overflow in DP service on TCP 3500.
        CVSS Critical. This check only detects the exposed service without
        sending destructive overflow payloads."""

    def verify(self, ip, port=80):
        """Check for vulnerable Lorex camera service"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Check TCP port 3500 for DP Service banner
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(self.config.timeout)
            result = sock.connect_ex((ip, 3500))
            if result == 0:
                # Port is open, try to receive a banner
                try:
                    banner = sock.recv(1024)
                    sock.close()
                    if banner:
                        return ip, str(port), self.product, 'N/A', 'N/A', self.name
                except Exception:
                    sock.close()
                    # Port is open even if no banner, service is present
                    return ip, str(port), self.product, 'N/A', 'N/A', self.name
            else:
                sock.close()
        except Exception as e:
            logger.error(e)

        # Check HTTP interface for Lorex 2K camera models
        url = self._get_url(ip, port, '/')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200:
                body = r.text
                if 'W461ASC' in body or 'W462AQC' in body or 'Lorex' in body:
                    return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2024_52544)
