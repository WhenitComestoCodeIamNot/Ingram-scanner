import requests

from loguru import logger

from .base import POCTemplate


class CVE_2023_21415(POCTemplate):
    """Axis VAPIX API Path Traversal

    A path traversal vulnerability exists in the VAPIX API of certain
    Axis devices. Unauthenticated or low-privileged attackers can read
    arbitrary files on the device by exploiting insufficient input
    validation in overlay-related CGI endpoints. CVSS 6.5 Medium.
    """

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['axis']
        self.product_version = ''
        self.ref = """
        https://nvd.nist.gov/vuln/detail/CVE-2023-21415
        https://www.axis.com/dam/public/89/d2/38/cve-2023-21415-en-US-417790.pdf
        """
        self.level = POCTemplate.level.medium
        self.desc = """Axis VAPIX API path traversal via overlay CGI endpoints.
        CVSS 6.5. Allows reading arbitrary files from the device filesystem
        through insufficient input validation."""

    def verify(self, ip, port=80):
        """Check for accessible Axis overlay CGI endpoints (path traversal vector)"""
        headers = self._get_headers()
        proxies = self._get_proxies()

        # Check overlay_del.cgi endpoint (path traversal vector)
        url = self._get_url(ip, port, '/axis-cgi/overlay_del.cgi?action=list')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200:
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        # Check param.cgi without auth for device info
        url = self._get_url(ip, port, '/axis-cgi/param.cgi?action=list')
        try:
            r = requests.get(
                url,
                headers=headers,
                proxies=proxies,
                verify=False,
                timeout=self.config.timeout,
                allow_redirects=False
            )
            if r.status_code == 200 and ('root.' in r.text or 'AXIS' in r.text):
                return ip, str(port), self.product, 'N/A', 'N/A', self.name
        except Exception as e:
            logger.error(e)

        return None

    def exploit(self, results):
        pass


POCTemplate.register_poc(CVE_2023_21415)
